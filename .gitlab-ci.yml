# =============================================================================
# CubeOS Docsindex Pipeline — Build multi-arch image, push to GHCR, deploy
# =============================================================================

stages:
  - package
  - deploy

variables:
  DOCSINDEX_IMAGE: "ghcr.io/cubeos-app/cubeos-docsindex"

# -----------------------------------------------------------------------------
# PACKAGE — Build multi-arch Docker image and push to GHCR
# -----------------------------------------------------------------------------
package:
  stage: package
  tags: [multiarch]
  image: docker:24
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
    - docker buildx create --name docsindexbuilder --driver docker-container --use
    - docker buildx inspect --bootstrap
  script:
    - |
      echo "Building multi-arch docsindex image..."
      docker buildx build --no-cache \
        --platform linux/amd64,linux/arm64 \
        --push \
        -t ${DOCSINDEX_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        -t ${DOCSINDEX_IMAGE}:latest \
        .
      echo "Pushed multi-arch ${DOCSINDEX_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  after_script:
    - docker buildx rm docsindexbuilder || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# DEPLOY — Redeploy Swarm stack on Pi (via SSH)
# -----------------------------------------------------------------------------
deploy:
  stage: deploy
  tags: [multiarch]
  image: alpine:latest
  needs:
    - package
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$CI_DEPLOY_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H ${PI_DEPLOY_ADDR} >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - scp scripts/ci-deploy.sh ${PI_DEPLOY_HOST}:/tmp/ci-deploy-docsindex.sh
    - |
      ssh -o ServerAliveInterval=15 ${PI_DEPLOY_HOST} \
        "GHCR_TOKEN='${GHCR_TOKEN}' GHCR_USER='${GHCR_USER}' bash /tmp/ci-deploy-docsindex.sh"
    - ssh ${PI_DEPLOY_HOST} "rm -f /tmp/ci-deploy-docsindex.sh"
  after_script:
    - kill $SSH_AGENT_PID 2>/dev/null || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production
